<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FGSSmap プレースマーク募集</title>
    <meta name="description" content="山口大学国際総合科学部10周年記念 - あなたの思い出の場所をFGSSmapに追加しませんか？">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans JP', 'Inter', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .header {
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 3rem 2rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 2.5rem;
            color: #2c3e50;
            margin-bottom: 1rem;
            font-weight: 700;
        }
        
        .header .subtitle {
            font-size: 1.1rem;
            color: #7f8c8d;
            margin-bottom: 2rem;
        }
        
        .header .university-badge {
            display: inline-block;
            background: linear-gradient(135deg, #3498db, #9b59b6);
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        /* ステップ進捗表示 */
        .progress-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .progress-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .progress-step {
            flex: 1;
            text-align: center;
            position: relative;
            padding: 0.5rem;
        }
        
        .progress-step::after {
            content: '';
            position: absolute;
            top: 50%;
            right: 0;
            width: 100%;
            height: 2px;
            background: #e0e0e0;
            z-index: 1;
        }
        
        .progress-step:last-child::after {
            display: none;
        }
        
        .progress-step.active::after {
            background: linear-gradient(to right, #667eea, #764ba2);
        }
        
        .progress-number {
            display: inline-block;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            color: #999;
            line-height: 40px;
            font-weight: 600;
            margin-bottom: 0.5rem;
            z-index: 2;
            position: relative;
        }
        
        .progress-step.active .progress-number {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .progress-step.completed .progress-number {
            background: #27ae60;
            color: white;
        }
        
        .progress-label {
            font-size: 0.8rem;
            color: #666;
        }
        
        .progress-step.active .progress-label {
            color: #333;
            font-weight: 600;
        }

        /* フォームコンテナ */
        .form-container {
            background: rgba(255, 255, 255, 0.95);
            padding: 3rem 2rem;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .step {
            display: none;
        }
        
        .step.active {
            display: block;
        }
        
        .step-title {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 1.5rem;
            text-align: center;
            font-weight: 600;
        }
        
        .step-description {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 2rem;
            font-size: 1rem;
        }

        /* フォーム要素 */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .form-label.required::after {
            content: ' *';
            color: #e74c3c;
        }
        
        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-control.error {
            border-color: #e74c3c;
            background-color: #fdf2f2;
        }
        
        .form-control.success {
            border-color: #27ae60;
            background-color: #f0f9f0;
        }
        
        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }

        /* 選択肢ボタン */
        .choice-buttons {
            display: grid;
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        .choice-button {
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-family: inherit;
            font-size: 1rem;
        }
        
        .choice-button:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        .choice-button.active {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .choice-button i {
            margin-right: 0.5rem;
            font-size: 1.2rem;
        }

        /* チェックボックス */
        .checkbox-container {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        .checkbox-container input[type="checkbox"] {
            margin-top: 0.2rem;
        }
        
        .checkbox-container.error {
            border-color: #e74c3c;
            background-color: #fdf2f2;
        }

        /* ナビゲーションボタン */
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 2rem;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.3s ease;
            font-family: inherit;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* エラーメッセージ */
        .error-message {
            background: #fdf2f2;
            color: #e74c3c;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            border-left: 4px solid #e74c3c;
        }
        
        .success-message {
            background: #f0f9f0;
            color: #27ae60;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            border-left: 4px solid #27ae60;
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .header {
                padding: 2rem 1rem;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .form-container {
                padding: 2rem 1rem;
            }
            
            .progress-steps {
                flex-wrap: wrap;
            }
            
            .progress-step {
                min-width: 100px;
                margin-bottom: 1rem;
            }
            
            .navigation-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .step-title {
                font-size: 1.4rem;
            }
            
            .choice-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ヘッダー -->
        <div class="header">
            <h1><i class="fas fa-map-marker-alt"></i> FGSSmap プレースマーク募集</h1>
            <p class="subtitle">あなたの思い出の場所をFGSSmapに追加しませんか？</p>
            <div class="university-badge">山口大学国際総合科学部 10周年記念プロジェクト</div>
        </div>

        <!-- プログレス表示 -->
        <div class="progress-container">
            <div class="progress-steps" id="progressSteps">
                <div class="progress-step active" data-step="1">
                    <div class="progress-number">1</div>
                    <div class="progress-label">同意確認</div>
                </div>
                <div class="progress-step" data-step="2">
                    <div class="progress-number">2</div>
                    <div class="progress-label">基本情報</div>
                </div>
                <div class="progress-step" data-step="3">
                    <div class="progress-number">3</div>
                    <div class="progress-label">地図範囲</div>
                </div>
                <div class="progress-step" data-step="4">
                    <div class="progress-number">4</div>
                    <div class="progress-label">地域選択</div>
                </div>
                <div class="progress-step" data-step="5">
                    <div class="progress-number">5</div>
                    <div class="progress-label">場所詳細</div>
                </div>
                <div class="progress-step" data-step="6">
                    <div class="progress-number">6</div>
                    <div class="progress-label">送信</div>
                </div>
            </div>
        </div>

        <!-- フォームコンテナ -->
        <div class="form-container">
            <form id="multiStepForm">
                <!-- ステップ1: 同意確認 -->
                <div class="step active" data-step="1">
                    <h2 class="step-title">プライバシー同意の確認</h2>
                    <p class="step-description">参加にあたり、以下の内容にご同意ください。</p>
                    
                    <div class="form-group">
                        <div class="checkbox-container" id="agreementContainer">
                            <input type="checkbox" id="privacyAgreement" name="privacyAgreement">
                            <label for="privacyAgreement">
                                <strong>プライバシーポリシーに同意します。</strong><br>
                                提供いただいた情報は、FGSSmap作成の目的のみに使用し、適切に管理いたします。個人を特定できる形での公開は行いません。
                            </label>
                        </div>
                    </div>
                </div>

                <!-- ステップ2: 基本情報 -->
                <div class="step" data-step="2">
                    <h2 class="step-title">基本情報の入力</h2>
                    <p class="step-description">あなたの基本情報を教えてください。</p>
                    
                    <div class="form-group">
                        <label for="name" class="form-label required">お名前（ニックネーム可）</label>
                        <input type="text" id="name" name="name" class="form-control" 
                               placeholder="例: 山口 太郎 または やまぐちさん">
                    </div>
                    
                    <div class="form-group">
                        <label for="admissionYear" class="form-label required">入学年度</label>
                        <select id="admissionYear" name="admissionYear" class="form-control">
                            <option value="">選択してください</option>
                            <option value="2015">2015年度</option>
                            <option value="2016">2016年度</option>
                            <option value="2017">2017年度</option>
                            <option value="2018">2018年度</option>
                            <option value="2019">2019年度</option>
                            <option value="2020">2020年度</option>
                            <option value="2021">2021年度</option>
                            <option value="2022">2022年度</option>
                            <option value="2023">2023年度</option>
                            <option value="2024">2024年度</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="department" class="form-label required">所属学部・コース</label>
                        <select id="department" name="department" class="form-control">
                            <option value="">選択してください</option>
                            <option value="国際総合科学部">国際総合科学部</option>
                            <option value="人文学部">人文学部</option>
                            <option value="教育学部">教育学部</option>
                            <option value="経済学部">経済学部</option>
                            <option value="理学部">理学部</option>
                            <option value="工学部">工学部</option>
                            <option value="農学部">農学部</option>
                            <option value="医学部">医学部</option>
                            <option value="その他">その他</option>
                        </select>
                    </div>
                </div>

                <!-- ステップ3: 地図範囲選択 -->
                <div class="step" data-step="3">
                    <h2 class="step-title">地図の範囲を選択</h2>
                    <p class="step-description">思い出の場所がある地図の範囲を選んでください。</p>
                    
                    <div class="choice-buttons">
                        <button type="button" class="choice-button" data-value="campus">
                            <i class="fas fa-university"></i>
                            キャンパス周辺
                        </button>
                        <button type="button" class="choice-button" data-value="japan">
                            <i class="fas fa-flag"></i>
                            日本全国
                        </button>
                        <button type="button" class="choice-button" data-value="world">
                            <i class="fas fa-globe"></i>
                            全世界
                        </button>
                    </div>
                    
                    <input type="hidden" id="mapType" name="mapType">
                </div>

                <!-- ステップ4: 地域選択 -->
                <div class="step" data-step="4">
                    <h2 class="step-title">地域を選択</h2>
                    <p class="step-description">思い出の場所がある地域を選んでください。</p>
                    
                    <!-- 日本国内用 -->
                    <div id="japanAreaSelection" style="display: none;">
                        <div class="form-group">
                            <label for="prefecture" class="form-label required">都道府県</label>
                            <select id="prefecture" name="prefecture" class="form-control">
                                <option value="">選択してください</option>
                                <option value="北海道">北海道</option>
                                <option value="青森県">青森県</option>
                                <option value="岩手県">岩手県</option>
                                <option value="宮城県">宮城県</option>
                                <option value="秋田県">秋田県</option>
                                <option value="山形県">山形県</option>
                                <option value="福島県">福島県</option>
                                <option value="茨城県">茨城県</option>
                                <option value="栃木県">栃木県</option>
                                <option value="群馬県">群馬県</option>
                                <option value="埼玉県">埼玉県</option>
                                <option value="千葉県">千葉県</option>
                                <option value="東京都">東京都</option>
                                <option value="神奈川県">神奈川県</option>
                                <option value="新潟県">新潟県</option>
                                <option value="富山県">富山県</option>
                                <option value="石川県">石川県</option>
                                <option value="福井県">福井県</option>
                                <option value="山梨県">山梨県</option>
                                <option value="長野県">長野県</option>
                                <option value="岐阜県">岐阜県</option>
                                <option value="静岡県">静岡県</option>
                                <option value="愛知県">愛知県</option>
                                <option value="三重県">三重県</option>
                                <option value="滋賀県">滋賀県</option>
                                <option value="京都府">京都府</option>
                                <option value="大阪府">大阪府</option>
                                <option value="兵庫県">兵庫県</option>
                                <option value="奈良県">奈良県</option>
                                <option value="和歌山県">和歌山県</option>
                                <option value="鳥取県">鳥取県</option>
                                <option value="島根県">島根県</option>
                                <option value="岡山県">岡山県</option>
                                <option value="広島県">広島県</option>
                                <option value="山口県">山口県</option>
                                <option value="徳島県">徳島県</option>
                                <option value="香川県">香川県</option>
                                <option value="愛媛県">愛媛県</option>
                                <option value="高知県">高知県</option>
                                <option value="福岡県">福岡県</option>
                                <option value="佐賀県">佐賀県</option>
                                <option value="長崎県">長崎県</option>
                                <option value="熊本県">熊本県</option>
                                <option value="大分県">大分県</option>
                                <option value="宮崎県">宮崎県</option>
                                <option value="鹿児島県">鹿児島県</option>
                                <option value="沖縄県">沖縄県</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 世界用 -->
                    <div id="worldAreaSelection" style="display: none;">
                        <div class="form-group">
                            <label for="worldArea" class="form-label required">世界の地域</label>
                            <select id="worldArea" name="worldArea" class="form-control">
                                <option value="">選択してください</option>
                                <option value="東アジア">東アジア（中国、韓国、台湾など）</option>
                                <option value="東南アジア">東南アジア（タイ、ベトナム、フィリピンなど）</option>
                                <option value="南アジア">南アジア（インド、バングラデシュなど）</option>
                                <option value="西アジア・中東">西アジア・中東（トルコ、イランなど）</option>
                                <option value="ヨーロッパ">ヨーロッパ</option>
                                <option value="北アメリカ">北アメリカ（アメリカ、カナダ）</option>
                                <option value="中南米">中南米</option>
                                <option value="アフリカ">アフリカ</option>
                                <option value="オセアニア">オセアニア（オーストラリア、ニュージーランドなど）</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- ステップ5: 場所詳細 -->
                <div class="step" data-step="5">
                    <h2 class="step-title">思い出の場所について</h2>
                    <p class="step-description">思い出の場所の詳細を教えてください。</p>
                    
                    <div class="form-group">
                        <label for="placeName" class="form-label required">場所の名前</label>
                        <input type="text" id="placeName" name="placeName" class="form-control" 
                               placeholder="例: 山口大学図書館、渋谷スクランブル交差点">
                    </div>
                    
                    <div class="form-group">
                        <label for="memoryContent" class="form-label required">思い出の内容</label>
                        <textarea id="memoryContent" name="memoryContent" class="form-control" 
                                  placeholder="この場所での思い出やエピソードを教えてください"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="locationInfo" class="form-label">住所・座標情報（任意）</label>
                        <textarea id="locationInfo" name="locationInfo" class="form-control" 
                                  placeholder="詳しい住所やGPS座標があれば教えてください"></textarea>
                    </div>
                    
                    <!-- 役立つフレーズ（海外選択時のみ表示） -->
                    <div id="usefulPhraseGroup" class="form-group" style="display: none;">
                        <label for="usefulPhrase" class="form-label">現地で役立つフレーズ（任意）</label>
                        <input type="text" id="usefulPhrase" name="usefulPhrase" class="form-control" 
                               placeholder="例: Where is the bathroom? / ¿Dónde está el baño?">
                    </div>
                </div>

                <!-- ステップ6: 送信確認 -->
                <div class="step" data-step="6">
                    <h2 class="step-title">送信確認</h2>
                    <p class="step-description">入力内容を確認して送信してください。</p>
                    
                    <div id="confirmationContent">
                        <!-- 確認内容がここに表示される -->
                    </div>
                    
                    <div id="submitMessage" style="display: none;"></div>
                </div>

                <!-- ナビゲーションボタン -->
                <div class="navigation-buttons">
                    <button type="button" id="prevBtn" class="btn btn-secondary" style="display: none;">
                        <i class="fas fa-chevron-left"></i> 前へ
                    </button>
                    
                    <div style="flex: 1;"></div>
                    
                    <button type="button" id="nextBtn" class="btn btn-primary" disabled>
                        次へ <i class="fas fa-chevron-right"></i>
                    </button>
                    
                    <button type="submit" id="submitBtn" class="btn btn-primary" style="display: none;">
                        <i class="fas fa-paper-plane"></i> 送信
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/google-forms.js"></script>
    <script>
        // 6ステップフォーム管理クラス
        class MultiStepFormManager {
            constructor() {
                this.currentStep = 1;
                this.totalSteps = 6;
                this.formData = {};
                
                this.initializeElements();
                this.bindEvents();
                this.updateUI();
                
                console.log('🚀 MultiStepFormManager初期化完了');
            }
            
            initializeElements() {
                this.form = document.getElementById('multiStepForm');
                this.steps = document.querySelectorAll('.step');
                this.progressSteps = document.querySelectorAll('.progress-step');
                this.prevBtn = document.getElementById('prevBtn');
                this.nextBtn = document.getElementById('nextBtn');
                this.submitBtn = document.getElementById('submitBtn');
                
                // 地図タイプ選択ボタン
                this.mapTypeButtons = document.querySelectorAll('.step[data-step="3"] .choice-button');
                
                console.log('📋 フォーム要素初期化完了');
            }
            
            bindEvents() {
                // ナビゲーションボタン
                this.prevBtn.addEventListener('click', () => this.previousStep());
                this.nextBtn.addEventListener('click', () => this.nextStep());
                this.submitBtn.addEventListener('click', (e) => this.handleSubmit(e));
                
                // 地図タイプ選択
                this.mapTypeButtons.forEach(button => {
                    button.addEventListener('click', (e) => this.handleMapTypeSelection(e));
                });
                
                // フォーム入力監視
                this.form.addEventListener('input', () => this.validateCurrentStep());
                this.form.addEventListener('change', () => this.validateCurrentStep());
                
                console.log('🔗 イベント登録完了');
            }
            
            handleMapTypeSelection(e) {
                const value = e.target.dataset.value;
                
                // ボタンの選択状態更新
                this.mapTypeButtons.forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                
                // 隠しフィールドに値設定
                document.getElementById('mapType').value = value;
                
                // フォームデータ更新
                this.formData.mapType = value;
                
                console.log('📍 地図タイプ選択:', value);
                this.validateCurrentStep();
            }
            
            validateCurrentStep() {
                let isValid = false;
                
                switch (this.currentStep) {
                    case 1: // 同意確認
                        isValid = document.getElementById('privacyAgreement').checked;
                        this.updateAgreementUI(isValid);
                        break;
                        
                    case 2: // 基本情報
                        const name = document.getElementById('name').value.trim();
                        const year = document.getElementById('admissionYear').value;
                        const dept = document.getElementById('department').value;
                        isValid = name && year && dept;
                        this.updateRequiredFields(['name', 'admissionYear', 'department']);
                        break;
                        
                    case 3: // 地図範囲
                        isValid = document.getElementById('mapType').value !== '';
                        break;
                        
                    case 4: // 地域選択
                        const mapType = document.getElementById('mapType').value;
                        if (mapType === 'japan') {
                            isValid = document.getElementById('prefecture').value !== '';
                            this.updateRequiredFields(['prefecture']);
                        } else if (mapType === 'world') {
                            isValid = document.getElementById('worldArea').value !== '';
                            this.updateRequiredFields(['worldArea']);
                        } else {
                            isValid = true; // キャンパス周辺の場合はスキップ
                        }
                        break;
                        
                    case 5: // 場所詳細
                        const placeName = document.getElementById('placeName').value.trim();
                        const memory = document.getElementById('memoryContent').value.trim();
                        isValid = placeName && memory;
                        this.updateRequiredFields(['placeName', 'memoryContent']);
                        break;
                        
                    case 6: // 送信確認
                        isValid = true;
                        this.generateConfirmation();
                        break;
                }
                
                this.nextBtn.disabled = !isValid;
                return isValid;
            }
            
            updateAgreementUI(isValid) {
                const container = document.getElementById('agreementContainer');
                if (isValid) {
                    container.classList.remove('error');
                } else {
                    container.classList.add('error');
                }
            }
            
            updateRequiredFields(fieldIds) {
                fieldIds.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    const value = field.value.trim();
                    
                    if (value) {
                        field.classList.remove('error');
                        field.classList.add('success');
                    } else {
                        field.classList.add('error');
                        field.classList.remove('success');
                    }
                });
            }
            
            nextStep() {
                if (!this.validateCurrentStep()) return;
                
                // 現在のステップのデータを保存
                this.saveCurrentStepData();
                
                // キャンパス周辺選択時のスキップロジック
                if (this.currentStep === 3 && this.formData.mapType === 'campus') {
                    this.currentStep = 5; // ステップ4をスキップして5へ
                    console.log('🏛️ キャンパス周辺選択: ステップ4をスキップ');
                } else {
                    this.currentStep++;
                }
                
                this.updateUI();
                this.validateCurrentStep();
            }
            
            previousStep() {
                // キャンパス周辺でステップ5から戻る場合
                if (this.currentStep === 5 && this.formData.mapType === 'campus') {
                    this.currentStep = 3; // ステップ4をスキップして3へ
                    console.log('🏛️ キャンパス周辺: ステップ4をスキップして戻る');
                } else {
                    this.currentStep--;
                }
                
                this.updateUI();
                this.validateCurrentStep();
            }
            
            saveCurrentStepData() {
                switch (this.currentStep) {
                    case 1:
                        this.formData.privacyAgreement = document.getElementById('privacyAgreement').checked;
                        break;
                    case 2:
                        this.formData.name = document.getElementById('name').value.trim();
                        this.formData.admissionYear = document.getElementById('admissionYear').value;
                        this.formData.department = document.getElementById('department').value;
                        break;
                    case 3:
                        this.formData.mapType = document.getElementById('mapType').value;
                        break;
                    case 4:
                        if (this.formData.mapType === 'japan') {
                            this.formData.area = document.getElementById('prefecture').value;
                        } else if (this.formData.mapType === 'world') {
                            this.formData.area = document.getElementById('worldArea').value;
                        }
                        break;
                    case 5:
                        this.formData.placeName = document.getElementById('placeName').value.trim();
                        this.formData.memoryContent = document.getElementById('memoryContent').value.trim();
                        this.formData.locationInfo = document.getElementById('locationInfo').value.trim();
                        this.formData.usefulPhrase = document.getElementById('usefulPhrase').value.trim();
                        break;
                }
                
                console.log('💾 ステップ', this.currentStep, 'データ保存:', this.formData);
            }
            
            updateUI() {
                // ステップ表示更新
                this.steps.forEach((step, index) => {
                    if (index + 1 === this.currentStep) {
                        step.classList.add('active');
                    } else {
                        step.classList.remove('active');
                    }
                });
                
                // プログレス表示更新
                this.progressSteps.forEach((step, index) => {
                    const stepNumber = index + 1;
                    if (stepNumber < this.currentStep) {
                        step.classList.add('completed');
                        step.classList.remove('active');
                    } else if (stepNumber === this.currentStep) {
                        step.classList.add('active');
                        step.classList.remove('completed');
                    } else {
                        step.classList.remove('active', 'completed');
                    }
                });
                
                // ナビゲーションボタン表示制御
                this.prevBtn.style.display = this.currentStep > 1 ? 'inline-flex' : 'none';
                this.nextBtn.style.display = this.currentStep < this.totalSteps ? 'inline-flex' : 'none';
                this.submitBtn.style.display = this.currentStep === this.totalSteps ? 'inline-flex' : 'none';
                
                // ステップ4の地域選択表示制御
                if (this.currentStep === 4) {
                    this.updateAreaSelection();
                }
                
                // ステップ5の役立つフレーズ表示制御
                if (this.currentStep === 5) {
                    this.updateUsefulPhraseVisibility();
                }
                
                console.log('🎨 UI更新完了 - ステップ:', this.currentStep);
            }
            
            updateAreaSelection() {
                const mapType = this.formData.mapType || document.getElementById('mapType').value;
                const japanArea = document.getElementById('japanAreaSelection');
                const worldArea = document.getElementById('worldAreaSelection');
                
                if (mapType === 'japan') {
                    japanArea.style.display = 'block';
                    worldArea.style.display = 'none';
                } else if (mapType === 'world') {
                    japanArea.style.display = 'none';
                    worldArea.style.display = 'block';
                } else {
                    // キャンパス周辺の場合、このステップはスキップされる
                    japanArea.style.display = 'none';
                    worldArea.style.display = 'none';
                }
            }
            
            updateUsefulPhraseVisibility() {
                const mapType = this.formData.mapType || document.getElementById('mapType').value;
                const usefulPhraseGroup = document.getElementById('usefulPhraseGroup');
                
                if (mapType === 'world') {
                    usefulPhraseGroup.style.display = 'block';
                } else {
                    usefulPhraseGroup.style.display = 'none';
                }
            }
            
            generateConfirmation() {
                const content = document.getElementById('confirmationContent');
                
                const mapTypeText = {
                    'campus': 'キャンパス周辺',
                    'japan': '日本全国',
                    'world': '全世界'
                };
                
                const areaText = this.formData.mapType === 'japan' 
                    ? this.formData.area 
                    : this.formData.mapType === 'world' 
                        ? this.formData.area 
                        : 'キャンパス周辺';
                
                content.innerHTML = `
                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; margin-bottom: 1rem;">
                        <h3 style="margin-bottom: 1rem; color: #2c3e50;">入力内容確認</h3>
                        
                        <div style="margin-bottom: 1rem;">
                            <strong>お名前:</strong> ${this.formData.name}<br>
                            <strong>入学年度:</strong> ${this.formData.admissionYear}年度<br>
                            <strong>所属学部:</strong> ${this.formData.department}
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <strong>地図範囲:</strong> ${mapTypeText[this.formData.mapType]}<br>
                            ${this.formData.mapType !== 'campus' ? `<strong>地域:</strong> ${areaText}<br>` : ''}
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <strong>場所名:</strong> ${this.formData.placeName}<br>
                            <strong>思い出:</strong><br>
                            <div style="background: white; padding: 0.75rem; border-radius: 5px; margin-top: 0.5rem;">
                                ${this.formData.memoryContent.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                        
                        ${this.formData.locationInfo ? `
                        <div style="margin-bottom: 1rem;">
                            <strong>位置情報:</strong><br>
                            <div style="background: white; padding: 0.75rem; border-radius: 5px; margin-top: 0.5rem;">
                                ${this.formData.locationInfo.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                        ` : ''}
                        
                        ${this.formData.usefulPhrase ? `
                        <div style="margin-bottom: 1rem;">
                            <strong>役立つフレーズ:</strong> ${this.formData.usefulPhrase}
                        </div>
                        ` : ''}
                    </div>
                `;
            }
            
            async handleSubmit(e) {
                e.preventDefault();
                
                console.log('📤 フォーム送信開始');
                this.submitBtn.disabled = true;
                this.submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 送信中...';
                
                try {
                    // 最新のデータを保存
                    this.saveCurrentStepData();
                    
                    // test.htmlと同じバリデーション
                    if (!this.formData.name || !this.formData.name.trim()) {
                        throw new Error('名前を入力してください');
                    }
                    if (!this.formData.memoryContent || !this.formData.memoryContent.trim()) {
                        throw new Error('思い出の内容を入力してください');
                    }
                    if (!this.formData.mapType) {
                        throw new Error('地図範囲を選択してください');
                    }
                    if (!this.formData.privacyAgreement) {
                        throw new Error('プライバシー同意が必要です');
                    }
                    
                    // Google Formsに送信 (test.htmlと同じ方式)
                    await window.GoogleFormsHandler.submitToGoogleForms(this.formData);
                    
                    console.log('✅ 送信成功');
                    this.showSuccessMessage();
                    
                } catch (error) {
                    console.error('❌ 送信エラー:', error);
                    this.showErrorMessage(error.message);
                }
            }
            
            showSuccessMessage() {
                const messageDiv = document.getElementById('submitMessage');
                messageDiv.style.display = 'block';
                messageDiv.className = 'success-message';
                messageDiv.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    <strong>送信完了！</strong><br>
                    ご協力ありがとうございました。あなたの思い出の場所がFGSSmapに追加されます。
                `;
                
                this.submitBtn.style.display = 'none';
                this.prevBtn.style.display = 'none';
            }
            
            showErrorMessage(errorMsg = null) {
                const messageDiv = document.getElementById('submitMessage');
                messageDiv.style.display = 'block';
                messageDiv.className = 'error-message';
                messageDiv.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>送信エラー</strong><br>
                    ${errorMsg || '申し訳ございませんが、送信に失敗しました。時間をおいて再度お試しください。'}
                `;
                
                this.submitBtn.disabled = false;
                this.submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> 再送信';
            }
        }
        
        // フォーム初期化 (test.htmlと同じ方式)
        document.addEventListener('DOMContentLoaded', () => {
            window.formManager = new MultiStepFormManager();
            console.log('🚀 6ステップフォーム準備完了');
            console.log('💡 各ステップを進めて送信ボタンをクリックしてください');
        });
    </script>
</body>
</html>
